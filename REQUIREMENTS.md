# プロジェクト要件定義書 (REQUIREMENTS.md)

## 1. アプリケーション概要
- 訪問看護・障害福祉サービスの請求および予実管理SaaS
- ユーザー：現場職員（スマホ・PC）、マネージャー（複数施設）、本社管理者（全権限）

## 2. 権限・マスタ設計
- **本社 (Admin):** 施設マスタには存在しない。権限設定により全施設のデータを閲覧・操作可能。
- **施設切替:** Adminおよび複数施設兼務者は、ヘッダーのプルダウンで表示対象施設を切り替える。
- **アカウント招待:** リンク共有形式（トークン認証）を採用。

## 3. 業務日誌・実績管理
- **入力:** 職員は日々のケア実績を入力。
- **バリデーション:**
  - 夜勤職員3名以下で「夜勤加配」チェックはNG（エラー）。
  - 日中活動ONなら「内容」必須。
  - 夜間状況（GH泊など）は必須。

## 4. 医療連携Ⅳ (訪問看護体制加算) ロジック
- **入力:** 利用者1名に対し、その日の担当看護師を選択（シングルセレクト）。
- **判定ロジック (重要):**
  - **IV 1:** その看護師が、同日に担当した利用者が **1名** の場合。
  - **IV 2:** その看護師が、同日に担当した利用者が **2名** の場合。
  - **IV 3:** その看護師が、同日に担当した利用者が **3名以上** の場合。
- **資格判定:** マスタ (`qualifications`) の `is_medical_target = true` の職員のみカウント対象。

## 5. 本社日次確認画面
- **表示:** 施設別・利用者別に行列表示（マトリクス）。
- **タブ構成:** 「業務日誌タブ」と「医療連携タブ」に分離。
- **機能:** CSVデータとの突合を行い、不一致箇所を赤色表示。
- **連絡事項:** 施設から本社への連絡は「解決済み」になるまでダッシュボードに残る。

## 6. 入院・外泊管理
- 日次の記録 (`daily_records`) から、連続する期間を自動計算して表示。
- 在籍日数は「操作日時点」までの日数をリアルタイム計算。
